<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeRunners - Plataforma</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="img/logo-192.png">
    <link rel="apple-touch-icon" href="img/logo-192.png">

    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <meta name="theme-color" content="#00008B">
    <style>
        /* Estilos Espec√≠ficos do M√≥dulo Financeiro (Aditivo) */
        .finance-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .finance-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #ccc; }
        .finance-card.receita { border-color: var(--success-color); }
        .finance-card.despesa { border-color: var(--danger-color); }
        .finance-card.saldo { border-color: var(--primary-color); }
        .finance-card h3 { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; }
        .finance-card p { font-size: 1.8rem; font-weight: bold; color: #333; margin: 0; }
        
        .table-responsive { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background-color: #f8f9fa; font-weight: 600; color: #444; }
        .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body class="app-page">

    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <p>Autenticando...</p>
    </div>

    <div id="app-container" class="hidden">
        
        <header class="app-header">
            <h1>LeRunners</h1>
            <nav>
                <button id="nav-planilha-btn" class="btn btn-nav active">
                    <i class='bx bx-calendar'></i> <span>Planilha</span>
                </button>
                <!-- BOT√ÉO FINANCEIRO (NOVO - Inicia Oculto) -->
                <button id="nav-finance-btn" class="btn btn-nav hidden">
                    <i class='bx bx-dollar-circle'></i> <span>Financeiro</span>
                </button>
                <button id="nav-feed-btn" class="btn btn-nav">
                    <i class='bx bx-news'></i> <span>Feed</span>
                </button>

                <button id="nav-profile-btn" class="btn btn-nav">
                    <i class='bx bx-user-circle'></i> <span>Meu Perfil</span>
                </button>

                <span id="userDisplay" class="user-display"></span>
                <button id="logoutButton" class="btn btn-danger">
                    <i class="bx bx-log-out"></i> Sair
                </button>
            </nav>
        </header>

        <main id="app-main-content" class="app-main">
            <!-- O conte√∫do din√¢mico entra aqui -->
        </main>
    </div>

    <footer class="app-footer">
        Desenvolvido com ü§ñ por thIAguinho Solu√ß√µes
    </footer>

    <!-- TEMPLATE DO ADMIN/COACH (PRESERVADO) -->
    <template id="admin-panel-template">
        <div class="admin-dashboard">
            <h2><i class="bx bx-shield-quarter"></i> Painel do Coach</h2>
            
            <div class="panel approval-panel">
                <h3><i class='bx bx-user-check'></i> Aprova√ß√µes Pendentes</h3>
                <div id="pending-list">
                    <!-- Lista injetada via JS -->
                </div>
            </div>

            <div class="admin-layout">
                <div class="athlete-list-container panel">
                    <h3><i class='bx bx-group'></i> Meus Atletas</h3>
                    <input type="text" id="athlete-search" class="search-input" placeholder="Pesquisar atleta...">
                    <div id="athlete-list" class="athlete-list">
                        <!-- Lista injetada via JS -->
                    </div>
                </div>
                <div class="athlete-details-container panel">
                    <h3 id="athlete-detail-name">Selecione um Atleta</h3>
                    
                    <div id="athlete-detail-content" class="hidden">
                        
                        <div class="admin-action-buttons">
                            <button id="delete-athlete-btn" class="btn btn-danger btn-small">
                                <i class='bx bx-user-x'></i> Excluir Aluno
                            </button>
                        </div>
                        
                        <div class="admin-tabs">
                            <button class="tab-btn active" data-tab="prescrever">Prescrever</button>
                            <button class="tab-btn" data-tab="kpis">KPIs & IA</button>
                        </div>

                        <div id="admin-tab-prescrever" class="admin-tab-content active">
                            <h4><i class='bx bx-calendar-edit'></i> Prescrever Treino</h4>
                            
                            <form id="add-workout-form" class="form-minimal">
                                <div class="form-grid-2col">
                                    <div class="form-group">
                                        <label for="workout-date">Data</label>
                                        <input type="date" id="workout-date" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="workout-title">T√≠tulo do Treino</label>
                                        <input type="text" id="workout-title" placeholder="Ex: Longo 10k Z2" required>
                                    </div>
                                </div>
                
                                <fieldset class="workout-fieldset">
                                    <legend>Detalhes do Treino (Estruturado)</legend>
                                    <div class="form-grid-2col">
                                        <div class="form-group">
                                            <label for="workout-modalidade">Modalidade</label>
                                            <select id="workout-modalidade">
                                                <option value="Corrida" selected>Corrida</option>
                                                <option value="Caminhada">Caminhada</option>
                                                <option value="Fortalecimento">Fortalecimento</option>
                                                <option value="Ciclismo">Ciclismo</option>
                                                <option value="Nata√ß√£o">Nata√ß√£o</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="workout-tipo-treino">Tipo de Treino</label>
                                            <select id="workout-tipo-treino">
                                                <option value="Rodagem" selected>Rodagem</option>
                                                <option value="Longo">Longo (Long√£o)</option>
                                                <option value="Intervalado">Intervalado (Tiros)</option>
                                                <option value="Fartlek">Fartlek</option>
                                                <option value="Progressivo">Progressivo</option>
                                                <option value="Regressivo">Regressivo</option>
                                                <option value="Competi√ß√£o">Competi√ß√£o/Prova</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="workout-intensidade">Intensidade</label>
                                            <select id="workout-intensidade">
                                                <option value="Leve (Z1/Z2)" selected>Leve (Z1/Z2)</option>
                                                <option value="Moderado (Z3)">Moderado (Z3)</option>
                                                <option value="Forte (Z4)">Forte (Z4)</option>
                                                <option value="Muito Forte (Z5/Tiro)">Muito Forte (Z5/Tiro)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="workout-percurso">Tipo de Percurso</label>
                                            <select id="workout-percurso">
                                                <option value="Asfalto/Rua" selected>Asfalto/Rua</option>
                                                <option value="Esteira">Esteira</option>
                                                <option value="Pista">Pista</option>
                                                <option value="Trilha/Montanha">Trilha/Montanha</option>
                                            </select>
                                        </div>
                                    </div>
                                </fieldset>
                                
                                <fieldset class="workout-fieldset">
                                    <legend>M√©tricas (Opcional)</legend>
                                     <div class="form-grid-4col">
                                        <div class="form-group">
                                            <label for="workout-distancia">Dist√¢ncia</label>
                                            <input type="text" id="workout-distancia" placeholder="Ex: 10 km">
                                        </div>
                                        <div class="form-group">
                                            <label for="workout-tempo">Tempo</label>
                                            <input type="text" id="workout-tempo" placeholder="Ex: 50 min">
                                        </div>
                                        <div class="form-group">
                                            <label for="workout-pace">Pace</label>
                                            <input type="text" id="workout-pace" placeholder="Ex: 5:00 /km">
                                        </div>
                                        <div class="form-group">
                                            <label for="workout-velocidade">Velocidade</label>
                                            <input type="text" id="workout-velocidade" placeholder="Ex: 12 km/h">
                                        </div>
                                    </div>
                                </fieldset>
                
                                <div class="form-group">
                                    <label for="workout-observacoes">Observa√ß√µes (Opcional)</label>
                                    <textarea id="workout-observacoes" rows="2" placeholder="Ex: Aquecer 10 min. Fazer na subida..."></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-secondary">
                                    <i class="bx bx-plus"></i> Salvar Treino
                                </button>
                            </form>
                            <hr>
                            <h4><i class='bx bx-history'></i> Treinos Agendados</h4>
                            <div id="workouts-list">
                                <!-- Lista injetada via JS -->
                            </div>
                        </div>

                        <div id="admin-tab-kpis" class="admin-tab-content">
                            <h4><i class='bx bxs-brain'></i> An√°lise de Performance (IA)</h4>
                             <button id="analyze-athlete-btn-ia" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
                                <i class='bx bxs-brain'></i> Gerar Nova An√°lise (Gemini)
                            </button>
                            
                            <h4><i class='bx bx-save'></i> Hist√≥rico de An√°lises Salvas</h4>
                            <div id="ia-history-list" class="ia-history-list">
                                <!-- Lista injetada via JS -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- NOVO TEMPLATE: FINANCEIRO (ADAPTADO) -->
    <template id="finance-panel-template">
        <div class="finance-dashboard">
            <h2><i class='bx bx-dollar-circle'></i> Gest√£o Financeira</h2>
            
            <div class="finance-summary">
                <div class="finance-card receita">
                    <h3>Receitas (M√™s)</h3>
                    <p id="fin-total-receita">R$ 0,00</p>
                </div>
                <div class="finance-card despesa">
                    <h3>Despesas (M√™s)</h3>
                    <p id="fin-total-despesa">R$ 0,00</p>
                </div>
                <div class="finance-card saldo">
                    <h3>Saldo Atual</h3>
                    <p id="fin-saldo">R$ 0,00</p>
                </div>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" data-fin-tab="lancamentos">Lan√ßamentos</button>
                <button class="tab-btn" data-fin-tab="estoque">Estoque & Produtos</button>
            </div>

            <!-- ABA 1: LAN√áAMENTOS -->
            <div id="fin-tab-lancamentos" class="fin-tab-content active">
                <div class="panel">
                    <h3>Novo Lan√ßamento</h3>
                    <form id="finance-transaction-form" class="form-minimal">
                        <div class="form-grid-2col">
                            <div class="form-group">
                                <label>Tipo</label>
                                <select id="fin-type" required>
                                    <option value="receita">Receita (Entrada)</option>
                                    <option value="despesa">Despesa (Sa√≠da)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="fin-category" required>
                                    <!-- Op√ß√µes mudam via JS -->
                                    <option value="Mensalidade">Mensalidade</option>
                                    <option value="Venda">Venda de Produto</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campos Din√¢micos -->
                        <div id="fin-student-selector" class="form-group hidden">
                            <label>Aluno</label>
                            <select id="fin-student-select">
                                <option value="">Selecione o Aluno...</option>
                            </select>
                        </div>
                        
                        <div id="fin-product-selector" class="form-group hidden">
                            <label>Produto do Estoque</label>
                            <select id="fin-product-select">
                                <option value="">Selecione o Produto...</option>
                            </select>
                        </div>

                        <div class="form-grid-2col">
                            <div class="form-group">
                                <label>Descri√ß√£o</label>
                                <input type="text" id="fin-description" placeholder="Ex: Mensalidade Janeiro" required>
                            </div>
                            <div class="form-group">
                                <label>Valor (R$)</label>
                                <input type="number" id="fin-amount" step="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="fin-date" required>
                        </div>
                        <button type="submit" class="btn btn-success">Salvar Lan√ßamento</button>
                    </form>
                </div>

                <div class="panel">
                    <h3>Hist√≥rico de Transa√ß√µes</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Cat.</th>
                                    <th>Valor</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="finance-transactions-list">
                                <!-- Injetado via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ABA 2: ESTOQUE -->
            <div id="fin-tab-estoque" class="fin-tab-content hidden">
                <div class="panel">
                    <h3>Cadastrar Produto</h3>
                    <form id="finance-product-form" class="form-minimal">
                        <div class="form-grid-4col">
                            <div class="form-group">
                                <label>Nome do Produto</label>
                                <input type="text" id="prod-name" placeholder="Ex: Camiseta P" required>
                            </div>
                            <div class="form-group">
                                <label>Pre√ßo Venda (R$)</label>
                                <input type="number" id="prod-price" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Custo (R$)</label>
                                <input type="number" id="prod-cost" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Qtd. Inicial</label>
                                <input type="number" id="prod-qty" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar ao Estoque</button>
                    </form>
                </div>

                <div class="panel">
                    <h3>Estoque Atual</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Pre√ßo Venda</th>
                                    <th>Qtd.</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="finance-inventory-list">
                                <!-- Injetado via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- TEMPLATE DO ATLETA (PRESERVADO) -->
    <template id="atleta-panel-template">
        <div class="atleta-dashboard">
            <div class="atleta-header">
                <h2><i class="bx bx-run"></i> Minha Planilha</h2>
                <button id="log-manual-activity-btn" class="btn btn-primary">
                    <i class='bx bx-plus-medical'></i> Registrar Atividade
                </button>
            </div>
            <p class="subtitle">Ol√°, <span id="atleta-welcome-name"></span>! Estes s√£o seus pr√≥ximos treinos.</p>
            
            <div id="atleta-workouts-container" class="panel">
                <h4>Meus Treinos</h4>
                <div id="atleta-workouts-list">
                    <!-- Lista injetada via JS -->
                </div>
            </div>
        </div>
    </template>

    <!-- TEMPLATE DO FEED (PRESERVADO) -->
    <template id="feed-panel-template">
        <div class="feed-dashboard">
            <h2><i class='bx bx-news'></i> Feed da Equipe</h2>
            <p class="subtitle">Veja o que a equipe est√° fazendo e deixe seu feedback.</p>
            <div id="feed-list" class="feed-list">
                <!-- Lista injetada via JS -->
            </div>
        </div>
    </template>


    <!-- MODAIS E COMPONENTES GLOBAIS (PRESERVADOS) -->
    <div id="feedback-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="feedback-modal-title">Feedback do Treino</h3>
                <button class="close-btn" id="close-feedback-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="feedback-form">
                    <input type="hidden" id="feedback-workout-id">
                    <input type="hidden" id="feedback-workout-owner-id">
                    
                    <fieldset>
                        <legend>Status do Treino</legend>
                        <div class="form-group">
                            <label for="workout-status">Como foi o treino?</label>
                            <select id="workout-status" required>
                                <option value="planejado" selected>Planejado</option>
                                <option value="realizado" style="color: var(--success-color);">Realizado</option>
                                <option value="realizado_parcial" style="color: var(--warning-color);">Realizado Parcialmente</option>
                                <option value="nao_realizado" style="color: var(--danger-color);">N√£o Realizado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workout-feedback-text">Como voc√™ se sentiu? (Obrigat√≥rio)</label>
                            <textarea id="workout-feedback-text" rows="3" placeholder="Ex: Senti o joelho no final, mas o pace foi bom..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="photo-upload-input">Anexar Foto (Opcional - Gemini pode ler dados do Strava)</label>
                            <input type="file" id="photo-upload-input" accept="image/*">
                            <p id="photo-upload-feedback" class="upload-feedback"></p>
                        </div>
                        
                        <fieldset id="strava-data-display" class="strava-data-display hidden">
                            <legend><i class='bx bxl-strava'></i> Dados Extra√≠dos (Gemini Vision)</legend>
                            <p id="strava-data-distancia"></p>
                            <p id="strava-data-tempo"></p>
                            <p id="strava-data-ritmo"></p>
                        </fieldset>

                        <button type="submit" id="save-feedback-btn" class="btn btn-primary">Salvar Feedback</button>
                    </fieldset>
                </form>
                
                <hr>

                <fieldset>
                    <legend>Coment√°rios (Coach/Atleta)</legend>
                    <div id="comments-list" class="comments-list">
                        <!-- Coment√°rios via JS -->
                    </div>
                    <form id="comment-form" class="comment-form">
                        <input type="text" id="comment-input" placeholder="Escreva um coment√°rio..." required>
                        <button type="submit" class="btn btn-secondary btn-small">
                            <i class='bx bxs-send'></i>
                        </button>
                    </form>
                </fieldset>
            </div>
        </div>
    </div>

    <div id="log-activity-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class='bx bx-plus-medical'></i> Registrar Nova Atividade</h3>
                <button class="close-btn" id="close-log-activity-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="log-activity-form">
                    <fieldset>
                        <legend>Detalhes da Atividade</legend>
                        <div class="form-group">
                            <label for="log-activity-date">Data</label>
                            <input type="date" id="log-activity-date" required>
                        </div>
                        <div class="form-group">
                            <label for="log-activity-type">Tipo de Atividade</label>
                            <select id="log-activity-type" required>
                                <option value="Corrida" selected>Corrida (N√£o prescrita)</option>
                                <option value="Academia">Academia</option>
                                <option value="Bike">Bike</option>
                                <option value="Nata√ß√£o">Nata√ß√£o</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="log-activity-title">T√≠tulo</label>
                            <input type="text" id="log-activity-title" placeholder="Ex: 5k na chuva" required>
                        </div>
                        <div class="form-group">
                            <label for="log-activity-feedback">Como voc√™ se sentiu? (Feedback)</label>
                            <textarea id="log-activity-feedback" rows="3" placeholder="Ex: Foi √≥timo, me senti forte..." required></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Salvar Atividade</button>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>

    <div id="who-liked-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class='bx bxs-heart'></i> Curtidas</h3>
                <button class="close-btn" id="close-who-liked-modal">&times;</button>
            </div>
            <div class="modal-body">
                <ul id="who-liked-list">
                    <!-- Lista via JS -->
                </ul>
            </div>
        </div>
    </div>

    <div id="ia-analysis-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class='bx bxs-brain'></i> An√°lise de Performance (Gemini IA)</h3>
                <button class="close-btn" id="close-ia-analysis-modal">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="ia-analysis-output">Gerando relat√≥rio...</pre>
            </div>
            <div class="modal-footer">
                <button id="save-ia-analysis-btn" class="btn btn-primary hidden">
                    <i class="bx bx-save"></i> Salvar An√°lise
                </button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class='bx bx-user-circle'></i> Meu Perfil</h3>
                <button class="close-btn" id="close-profile-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <fieldset>
                        <legend>Minhas Informa√ß√µes</legend>
                        
                        <div class="profile-pic-container">
                            <img src="https://placehold.co/150x150/4169E1/FFFFFF?text=Atleta" alt="Foto do Perfil" id="profile-pic-preview" class="profile-pic-preview">
                        </div>

                        <div class="form-group">
                            <label for="profile-pic-upload">Alterar Foto (Opcional)</label>
                            <input type="file" id="profile-pic-upload" accept="image/*">
                            <p id="profile-upload-feedback" class="upload-feedback"></p>
                        </div>
                        <div class="form-group">
                            <label for="profile-name">Nome Completo</label>
                            <input type="text" id="profile-name" required>
                        </div>
                        <div class="form-group">
                            <label for="profile-bio">Biografia (Opcional)</label>
                            <textarea id="profile-bio" rows="3" placeholder="Fale um pouco sobre voc√™, seus objetivos..."></textarea>
                        </div>
                        
                        <button type="submit" id="save-profile-btn" class="btn btn-primary">Salvar Perfil</button>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>

    <div id="view-profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class='bx bx-user'></i> Perfil do Atleta</h3>
                <button class="close-btn" id="close-view-profile-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-pic-container">
                    <img src="https://placehold.co/150x150/4169E1/FFFFFF?text=Atleta" alt="Foto do Atleta" id="view-profile-pic" class="profile-pic-preview">
                </div>
                <h2 id="view-profile-name" class="view-profile-name">Carregando...</h2>
                <p id="view-profile-bio" class="view-profile-bio">Carregando...</p>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <script src="js/config.js"></script>
    <script src="js/app.js"></script> 
    <script src="js/panels.js"></script> 
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Falha ao registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>